# Claude Code Checkpoint Summary - Design Document v2.0

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2025-01-18 | Initial design - Session ID and Checkpoint Reference System |
| 2.0 | 2025-01-19 | Use Claude Code native Session ID (UUID format), add timestamps, enhance metadata |
| 2.1 | 2025-01-19 | Fix: Session ID is UUID (36 chars), not 16 hex |

---

## Table of Contents

1. [Problem Statement](#problem-statement)
2. [Session ID System (Claude Code Native)](#session-id-system-claude-code-native)
3. [Checkpoint Reference System](#checkpoint-reference-system)
4. [Cross-Session Linking](#cross-session-linking)
5. [Retrieval Mechanism](#retrieval-mechanism)
6. [Metadata Schema v2.0](#metadata-schema-v20)
7. [Implementation Flow](#implementation-flow)
8. [API Specification](#api-specification)
9. [Examples](#examples)

---

## Problem Statement

### Current Issue

Checkpoint ที่สร้างใน session หนึ่ง ไม่สามารถระบุได้แม่นยำว่า:
- เกิดจาก session ไหน (session ID อะไร)
- ถูกสร้างเมื่อไร (timestamp ไม่พอ)
- มี checkpoint กี่ตัว ใน session เดียวกัน
- checkpoint ไหนเป็น checkpoint สุดท้ายก่อน clear

### Requirements

- ✅ ใช้ Session ID เต็มของ Claude Code (UUID format, 36 chars)
- ✅ Checkpoint ID ที่อ้างอิงถึง session ได้ชัดเจน
- ✅ สามารถระบุ checkpoint ล่าสุดของ session ได้
- ✅ สามารถ trace ประวัติ session ได้ (session lineage)
- ✅ มี timestamp และรายละเอียดครบถ้วน

---

## Session ID System (Claude Code Native)

### Session ID Format (Claude Code Native)

```
Format: <UUID v4>
Pattern: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
         8        4    4    4    12
Total: 36 characters (32 hex + 4 hyphens)

Example: 7670db3a-2057-406a-a109-afcedef1cb97

Entropy: 2^122 = 5.3×10^36 possibilities
Security: Excellent for session isolation

Source: Generated by Claude Code (UUID v4 standard)
```

### Session Metadata v2.0

```typescript
interface SessionMetadata {
  session_id: string;        // UUID format (36 chars) - Claude Code native
  started_at: string;        // ISO 8601 timestamp
  started_at_unix: number;   // Unix timestamp (milliseconds)
  parent_session?: string;   // ถ้าเกิดจาก /clear อ้างถึง session เดิม
  checkpoint_count: number;  // จำนวน checkpoint ที่สร้างใน session นี้
  last_checkpoint?: string;  // Checkpoint ID ล่าสุด
  cleared: boolean;          // true ถ้า session ถูก clear แล้ว

  // เพิ่มเติม v2.0
  duration_seconds?: number;     // ระยะเวลา session (วินาที)
  message_count: number;         // จำนวนข้อความใน session
  working_directory: string;     // ที่อยู่ working directory
  hostname?: string;             // ชื่อเครื่อง (ถ้ามี)
}
```

---

## Checkpoint Reference System

### Checkpoint ID Format v2.0

```
Format: ccp-<session_uuid>-<seq>-<timestamp>

Components:
- Prefix: "ccp" (Claude Code Checkpoint)
- Session ID: UUID format (36 chars) - Claude Code native, full
- Sequence: ลำดับ checkpoint ใน session (01, 02, 03, ...)
- Timestamp: Unix timestamp (milliseconds)

Example: ccp-7670db3a-2057-406a-a109-afcedef1cb97-01-1737196625000
         └─ session: 7670db3a-2057-406a-a109-afcedef1cb97 (full UUID)
         └─ checkpoint ที่ 1
         └─ สร้าง 2025-01-18 15:23:45 (Unix ms)

Length: ccp- (4) + UUID (36) + -seq (3-4) + -timestamp (13-14)
       ≈ 56-58 characters total
```

### Checkpoint Metadata v2.0

```typescript
interface CheckpointMetadata {
  checkpoint_id: string;     // ccp-<uuid>-<seq>-<timestamp_ms>
  session_id: string;        // UUID format (36 chars, Claude Code native)
  sequence: number;          // 1, 2, 3, ...

  // Timestamps
  created_at: string;        // ISO 8601 timestamp
  created_at_unix: number;   // Unix timestamp (milliseconds)
  checkpoint_type: string;   // 'auto', 'manual', 'before-clear'

  // Content summary
  title: string;
  summary: string;           // สรุปเนื้อหา session
  topics: string[];
  key_outcomes: string[];    // ผลลัพธ์สำคัญ
  files_referenced: string[];

  // Observation references (ใน claude-mem)
  observation_ids: number[]; // [8044, 8045, 8046]

  // Session state at checkpoint time
  message_count: number;
  duration_seconds?: number;
  commands_executed?: number;
  tools_used?: string[];

  // Relations
  previous_checkpoint?: string; // checkpoint ID ก่อนหน้า
  next_checkpoint?: string;     // checkpoint ID ถัดไป (ถ้ามี)
  parent_session?: string;      // parent session ID (ถ้ามี)

  // System info (เพิ่ม v2.0)
  working_directory: string;
  hostname?: string;
  claude_code_version?: string;
}
```

### Checkpoint Types

| Type | Description | Trigger |
|------|-------------|---------|
| `auto` | Auto-checkpoint | Session ใหญ่เกินไป |
| `manual` | ผู้ใช้สร้างเอง | `/checkpoint` |
| `before-clear` | Before clear | Hook: `UserPromptSubmit` blocks `/clear` until `/checkpoint` exists |

---

## Cross-Session Linking

### Session Lineage

```
Session A (7670db3a-2057-406a-a109-afcedef1cb97)
  ├─ Started: 2025-01-18T10:00:00Z
  ├─ Checkpoint 1: ccp-7670db3a-2057-406a-a109-afcedef1cb97-01-1737196600000
  ├─ Checkpoint 2: ccp-7670db3a-2057-406a-a109-afcedef1cb97-02-1737196660000
  └─ /clear → เกิด Session B

Session B (b4e9c3d0-e5f6-a7b8-c9d0-e1f2a3b4c5d6)
  ├─ Started: 2025-01-18T10:20:30Z
  ├─ parent_session: 7670db3a-2057-406a-a109-afcedef1cb97
  ├─ Checkpoint 1: ccp-b4e9c3d0-e5f6-a7b8-c9d0-e1f2a3b4c5d6-01-1737197230000
  └─ อ้างถึง checkpoint สุดท้ายของ Session A
```

### Metadata Tracking

```typescript
interface SessionLineage {
  current_session: string;
  parent_session?: string;
  root_session?: string;

  // ประวัติทั้งหมด
  session_chain: SessionLink[];
}

interface SessionLink {
  session_id: string;
  started_at: string;
  started_at_unix: number;
  checkpoint_count: number;
  last_checkpoint_id: string;
  duration_seconds: number;
}
```

---

## Retrieval Mechanism

### Search Patterns

```bash
# 1. หา checkpoint ล่าสุดของ session ปัจจุบัน
/mem-search query="checkpoint session:7670db3a-2057-406a-a109-afcedef1cb97 latest"

# 2. หา checkpoint ทั้งหมดของ session หนึ่ง
/mem-search query="checkpoint session:7670db3a-2057-406a-a109-afcedef1cb97"

# 3. หา checkpoint จาก session ก่อนหน้า
/mem-search query="checkpoint parent:7670db3a-2057-406a-a109-afcedef1cb97"

# 4. หา checkpoint ด้วย checkpoint ID
/mem-search query="checkpoint:ccp-7670db3a-2057-406a-a109-afcedef1cb97-01-1737196625000"

# 5. หา checkpoint ล่าสุดทั้งหมด
/mem-search query="checkpoint latest sort:desc"

# 6. หา checkpoint ด้วยช่วงเวลา
/mem-search query="checkpoint after:2025-01-18 before:2025-01-19"
```

### Observation Template v2.0 สำหรับ Checkpoint

```
Title: Checkpoint [seq]: <title> - Session <session_uuid>

Type: discovery

Content:
## Checkpoint Reference
- Checkpoint ID: ccp-<session_uuid>-<seq>-<timestamp_ms>
- Session ID: <session_uuid> (UUID format)
- Sequence: <seq> of <total>
- Type: <auto|manual|before-clear>
- Created: <ISO_8601_TIMESTAMP>
- Created (Unix): <UNIX_TIMESTAMP_MS>

## Session Context
- Started: <session_start_time> (ISO)
- Started (Unix): <session_start_unix_ms>
- Duration: <duration_seconds> seconds
- Messages: <count>
- Working Directory: <cwd>
- Parent Session: <parent_uuid or none>

## Summary
<session summary>

## Key Outcomes
- <outcome 1>
- <outcome 2>

## Files Referenced
- <file1>
- <file2>

## Tools Used
- <tool1>
- <tool2>

## Related Checkpoints
- Previous: <previous_checkpoint_id or none>
- Next: <next_checkpoint_id or none>

## Retrieval Queries
# Restore this checkpoint
/mem-search query="checkpoint:ccp-<session_uuid>-<seq>-<timestamp_ms>"

# All checkpoints in this session
/mem-search query="checkpoint session:<session_uuid>"

# Session lineage
/mem-search query="session lineage:<root_session_uuid>"

Metadata:
{
  "version": "2.1",
  "format": "claude-code-checkpoint",
  "checkpoint_id": "ccp-<session_uuid>-<seq>-<timestamp_ms>",
  "session_id": "<session_uuid>",
  "sequence": <seq>,
  "type": "checkpoint",
  "checkpoint_type": "<auto|manual|before-clear>",
  "created_at": "<ISO_TIMESTAMP>",
  "created_at_unix": <UNIX_MS>,
  "parent_session": "<parent_uuid or null>",
  "topics": ["<topic1>", "<topic2>"],
  "files": ["<file1>", "<file2>"],
  "tools_used": ["<tool1>", "<tool2>"],
  "observation_ids": [<id1>, <id2>],
  "latest_checkpoint": <true|false>,
  "working_directory": "<cwd>",
  "hostname": "<hostname or null>",
  "claude_code_version": "<version or null>"
}

Tags:
checkpoint, session-<session_uuid>, <auto-generated-topics>
```

---

## Metadata Schema v2.0

### Complete Checkpoint Record v2.1

```json
{
  "version": "2.1",
  "format": "claude-code-checkpoint",

  "checkpoint": {
    "id": "ccp-7670db3a-2057-406a-a109-afcedef1cb97-01-1737196625000",
    "session_id": "7670db3a-2057-406a-a109-afcedef1cb97",
    "sequence": 1,
    "type": "manual",
    "created_at": "2025-01-18T15:23:45.000Z",
    "created_at_unix": 1737196625000,

    "content": {
      "title": "Session Checkpoint: Video Extension API Design",
      "summary": "ออกแบบระบบ checkpoint สำหรับ Claude Code...",
      "topics": ["checkpoint", "session-management", "claude-mem"],
      "key_outcomes": [
        "ระบุสาเหตุ session growth",
        "ออกแบบ checkpoint reference system"
      ],
      "files_referenced": ["design.video.md"]
    },

    "session_state": {
      "message_count": 12,
      "duration_seconds": 450,
      "files_modified": 1,
      "commands_executed": 3,
      "tools_used": ["Read", "Write", "Bash"]
    },

    "system_info": {
      "working_directory": "/home/user/project",
      "hostname": "localhost",
      "claude_code_version": "1.0.0"
    },

    "observations": {
      "master_summary_id": 8044,
      "detailed_ids": [8045, 8046],
      "total_count": 3
    },

    "relations": {
      "previous_checkpoint": null,
      "next_checkpoint": null,
      "parent_session": null,
      "root_session": "7670db3a-2057-406a-a109-afcedef1cb97"
    },

    "tags": ["checkpoint", "session-7670db3a-2057-406a-a109-afcedef1cb97", "claude-mem", "session-management"]
  }
}
```

### Session Record v2.1

```json
{
  "version": "2.1",
  "format": "claude-code-session",

  "session": {
    "id": "7670db3a-2057-406a-a109-afcedef1cb97",
    "started_at": "2025-01-18T15:22:30.000Z",
    "started_at_unix": 1737196650000,
    "ended_at": null,
    "parent_session": null,
    "root_session": "7670db3a-2057-406a-a109-afcedef1cb97",

    "checkpoints": {
      "count": 1,
      "latest": "ccp-7670db3a-2057-406a-a109-afcedef1cb97-01-1737196625000",
      "all": ["ccp-7670db3a-2057-406a-a109-afcedef1cb97-01-1737196625000"]
    },

    "metadata": {
      "cleared": false,
      "auto_checkpoint_enabled": true,
      "working_directory": "/home/user/project",
      "hostname": "localhost"
    }
  }
}
```

---

## Implementation Flow

### Flow 1: เริ่ม Session ใหม่

```
Session Start (Claude Code native)
├─ Get Session ID from Claude Code
│  └─ a3f8b2c9d4e5f6a7 (16 hex, generated by Claude Code)
├─ Create Session Record
│  ├─ session_id
│  ├─ started_at (ISO)
│  ├─ started_at_unix (ms)
│  ├─ working_directory
│  ├─ parent_session (ถ้ามี)
│  └─ checkpoint_count = 0
└─ Store in accessible location
   └─ env var, temp file, or memory
```

### Flow 2: สร้าง Checkpoint

```
Checkpoint Creation (/checkpoint)
├─ Read current session metadata
│  ├─ session_id (16 hex)
│  ├─ checkpoint_count
│  └─ last_checkpoint
├─ Increment checkpoint_count
├─ Generate Checkpoint ID
│  └─ ccp-<session_id>-<seq>-<unix_timestamp_ms>
├─ Capture timestamps
│  ├─ created_at (ISO)
│  └─ created_at_unix (ms)
├─ Analyze session
│  ├─ Extract topics
│  ├─ Summarize content
│  ├─ List files
│  └─ Track tools used
├─ Create observations
│  ├─ Master summary
│  └─ Detailed observations
├─ Update session record
│  ├─ checkpoint_count++
│  └─ last_checkpoint = new_checkpoint_id
├─ Return checkpoint report
└─ (No auto /clear)
   └─ After checkpoint, user runs /clear manually
```

### Flow 3: Session ใหม่หลัง Clear

```
New Session After Clear
├─ Get NEW Session ID from Claude Code
│  └─ b4e9c3d0e5f6a7b8 (new 16 hex)
├─ Link to previous session
│  ├─ parent_session = a3f8b2c9d4e5f6a7
│  └─ root_session = a3f8b2c9d4e5f6a7
├─ Enable quick retrieval
│  └─ Suggest query for last checkpoint
└─ User can restore context
   └─ /mem-search query="checkpoint:<last_checkpoint_id>"
```

### Flow 4: Restore Context

```
Context Restoration
├─ User runs retrieval query
│  └─ /mem-search query="checkpoint session:a3f8b2c9d4e5f6a7"
├─ System finds checkpoint observation
├─ Display checkpoint summary
│  ├─ Session info (with timestamps)
│  ├─ Key outcomes
│  └─ Related observations
└─ User has full context
   └─ สามารถทำต่อได้ทันที
```

---

## API Specification

### Skill: /checkpoint

```bash
/checkpoint [options]

Options:
  --summary-only       Only create master summary
  --include-files      Include file change details
  --tags <tags>        Custom comma-separated tags
  --title <title>      Custom checkpoint title

Note:
- `/checkpoint` does NOT auto-run `/clear`.
- Use Hook policy to enforce: user must run `/checkpoint` before `/clear`.

Output:
  Console report + Observation in claude-mem
```

### Skill: /session-info

```bash
/session-info

Display:
- Current session ID (16 hex)
- Parent session ID (if any)
- Checkpoint count
- Last checkpoint ID
- Session duration (seconds)
- Working directory
- Message count
```

### Environment Variables

```bash
# Session tracking
CLAUDE_SESSION_ID="a3f8b2c9d4e5f6a7"
CLAUDE_SESSION_START="2025-01-18T15:22:30.000Z"
CLAUDE_SESSION_START_UNIX="1737196650000"
CLAUDE_SESSION_PARENT="b4e9c3d0e5f6a7b8"
CLAUDE_SESSION_ROOT="a3f8b2c9d4e5f6a7"
CLAUDE_SESSION_CWD="/home/user/project"

# Checkpoint tracking
CLAUDE_LAST_CHECKPOINT="ccp-a3f8b2c9d4e5f6a7-01-1737196625000"
CLAUDE_CHECKPOINT_COUNT="1"
```

---

## Examples

### Example 1: Basic Checkpoint

```bash
# User runs
/checkpoint

# System output
Creating Session Checkpoint...

Session Information:
├─ Session ID: 7670db3a-2057-406a-a109-afcedef1cb97
├─ Started: 2025-01-18 15:22:30
├─ Started (Unix): 1737196650000
├─ Duration: 8 minutes (480 seconds)
├─ Messages: 15
├─ Working Directory: /home/user/project
└─ Checkpoints: 0 → 1

Analyzing session...
  Topics identified: session-growth, checkpoint-design
  Files referenced: design.video.md
  Tools used: Read, Write, Bash

Creating observations...
  Master summary: ID #8047
  Detailed: 2 observations

Checkpoint Created

Checkpoint ID: ccp-7670db3a-2057-406a-a109-afcedef1cb97-01-1737196625000
Session ID: 7670db3a-2057-406a-a109-afcedef1cb97
Sequence: 1 (first checkpoint)
Created: 2025-01-18 15:23:45.000Z

Observations:
  1. #8047 - Master Summary
  2. #8048 - Session Growth Analysis
  3. #8049 - Checkpoint Design

Restore this checkpoint:
  /mem-search query="checkpoint:ccp-7670db3a-2057-406a-a109-afcedef1cb97-01-1737196625000"

View all session checkpoints:
  /mem-search query="checkpoint session:7670db3a-2057-406a-a109-afcedef1cb97"
```

### Example 2: Multiple Checkpoints in Session

```bash
# First checkpoint
/checkpoint --title "Initial Design"

Checkpoint: ccp-7670db3a-2057-406a-a109-afcedef1cb97-01-1737196600000 (Sequence 1)
Created: 2025-01-18 15:10:00.000Z

# ... work continues ...

# Second checkpoint
/checkpoint --title "Implementation Started"

Checkpoint: ccp-7670db3a-2057-406a-a109-afcedef1cb97-02-1737196960000 (Sequence 2)
Created: 2025-01-18 15:16:00.000Z

# ... more work ...

# Third checkpoint
/checkpoint --title "Ready for Testing"

Checkpoint: ccp-7670db3a-2057-406a-a109-afcedef1cb97-03-1737197220000 (Sequence 3)
Created: 2025-01-18 15:27:00.000Z

# User clears session
/clear

# In new session - find all
/mem-search query="checkpoint session:7670db3a-2057-406a-a109-afcedef1cb97"

Results:
  ccp-7670db3a-2057-406a-a109-afcedef1cb97-01-1737196600000 - Initial Design (15:10:00)
  ccp-7670db3a-2057-406a-a109-afcedef1cb97-02-1737196960000 - Implementation Started (15:16:00)
  ccp-7670db3a-2057-406a-a109-afcedef1cb97-03-1737197220000 - Ready for Testing (15:27:00) ← Latest
```

### Example 3: Session Lineage

```bash
# Session A
Session ID: 7670db3a-2057-406a-a109-afcedef1cb97
Started: 2025-01-18 10:00:00
Checkpoints: 2

# /clear

# Session B
Session ID: b4e9c3d0-e5f6-a7b8-c9d0-e1f2a3b4c5d6
Parent: 7670db3a-2057-406a-a109-afcedef1cb97
Started: 2025-01-18 10:20:30
Checkpoints: 1

# Query lineage
/mem-search query="session lineage:7670db3a-2057-406a-a109-afcedef1cb97"

Lineage:
  Session A: 7670db3a-2057-406a-a109-afcedef1cb97 (root)
    ├─ Checkpoint 1: ccp-7670db3a-2057-406a-a109-afcedef1cb97-01-...
    └─ Checkpoint 2: ccp-7670db3a-2057-406a-a109-afcedef1cb97-02-...
         ↓
  Session B: b4e9c3d0-e5f6-a7b8-c9d0-e1f2a3b4c5d6 (child)
    └─ Checkpoint 1: ccp-b4e9c3d0-e5f6-a7b8-c9d0-e1f2a3b4c5d6-01-...
```

---

## Storage Strategy

### Where to Store Session Metadata

```
Storage Options
├─ Environment Variables (fastest, session-scoped)
│  └─ $CLAUDE_SESSION_ID, $CLAUDE_LAST_CHECKPOINT
│
├─ Temporary Files (persistent across restarts)
│  └─ /tmp/claude-session-<pid>.json
│
├─ Claude-Mem Observations (permanent, searchable)
│  └─ Store session record as observation
│
└─ Combination (recommended)
   ├─ Environment for fast access
   ├─ Temp file for backup
   └─ Observation for long-term
```

---

## Edge Cases

### Case 1: Checkpoint แรกของ Session

```
Session: a3f8b2c9d4e5f6a7
Checkpoint 1: ccp-a3f8b2c9d4e5f6a7-01-1737196625000

Previous checkpoint: (null) - ไม่มี
Sequence: 1 (first checkpoint)
```

### Case 2: Session ถูก clear กลางคัน

```
Session A (incomplete)
├─ Checkpoint 1: ccp-a3f8b2c9d4e5f6a7-01-...
├─ Checkpoint 2: ccp-a3f8b2c9d4e5f6a7-02-...
└─ /clear (unexpected)

Session metadata จะบันทึกว่า cleared=true
Checkpoint ที่สร้างไปยังคงอยู่ใน claude-mem
```

### Case 3: Multiple /clear ติดกัน

```
Session A → /clear → Session B → /clear → Session C

Lineage:
Session C
├─ parent: Session B
└─ root: Session A

Can trace back:
/mem-search query="session lineage:a3f8b2c9d4e5f6a7"
```

---

## Best Practices

### When to Create Checkpoints

```
Checkpoint Triggers
├─ Manual (/checkpoint)
│  └─ ผู้ใช้ตัดสินใจเอง
│
├─ Before Clear (Hook-enforced)
│  └─ Hook blocks /clear unless a recent /checkpoint exists
│
└─ Auto (future feature)
   └─ Session size > threshold
```

### Checkpoint Frequency

```
Guidelines:
├─ Small session (< 50 messages)
│  └─ Checkpoint เมื่อจะ clear หรือจบงาน
│
├─ Medium session (50-200 messages)
│  └─ Checkpoint ทุก milestone สำคัญ
│
└─ Large session (> 200 messages)
   └─ Checkpoint ทุก 30-50 messages
```

---

## Version 2.0 Changes Summary

``| Feature | v1.0 | v2.0 |
|---------|------|------|
| Session ID Format | cc-sess-YYYYMMDD-HHMMSS-xxxxxx | <16 hex> (Claude Code native) |
| Session ID Source | Custom generation | Claude Code native |
| Checkpoint ID Format | ccp-<session_short>-<seq>-<YYMMDDHHMM> | ccp-<session_id>-<seq>-<unix_ms> |
| Timestamps | ISO only | ISO + Unix (ms) |
| Working Directory | No | Yes |
| Hostname | No | Yes |
| Tools Tracking | No | Yes |
| Version Field | No | Yes |
| Format Field | No | Yes |
```

---

## Appendix A: ID Formats Reference v2.1

### Quick Reference

```
Session ID (Claude Code Native - UUID):
  Format: <UUID v4>
  Pattern: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
  Length: 36 characters (32 hex + 4 hyphens)
  Example: 7670db3a-2057-406a-a109-afcedef1cb97
  Source: Claude Code native (UUID v4 standard)
  Entropy: 2^122 = 5.3×10^36 possibilities

Checkpoint ID v2.1:
  Format: ccp-<session_uuid>-<seq>-<unix_ms>
  Length: ~56-58 characters
  Example: ccp-7670db3a-2057-406a-a109-afcedef1cb97-01-1737196625000
  Parts:
    - ccp: Checkpoint prefix (4 chars)
    - session_uuid: Full UUID (36 chars)
    - seq: Sequence number with prefix (3-4 chars)
    - unix_ms: Unix timestamp in milliseconds (13 chars)

Query Formats:
- checkpoint:ccp-7670db3a-2057-406a-a109-afcedef1cb97-01-1737196625000
- checkpoint session:7670db3a-2057-406a-a109-afcedef1cb97
- checkpoint latest
- session lineage:7670db3a-2057-406a-a109-afcedef1cb97
```

---

**End of Design Document v2.1**
